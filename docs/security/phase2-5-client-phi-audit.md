# Phase 2.5 Client-Side PHI Supabase Audit (Report-Only)

Scope: `apps/web`, `apps/mobile`, and shared packages used by those apps. Focused on client/browser Supabase usage and direct table queries touching PHI/PHI-adjacent tables.

## Summary Counts

- Client-side Supabase client creation (web client/mobile): 4
- Client-side PHI table queries (mobile/shared): 3
- Web app server-component PHI table queries (non-API): 4
- Web client PHI queries: 0 (no `use client` components calling Supabase directly)

## Findings Table

| file_path                                        | client/runtime (web client / web server / mobile) | supabase client type (anon/service) | tables touched                                                                               | operation (select/insert/update/delete) | PHI risk (high/med/low) | what screen/feature                 | suggested replacement (existing API route)                                                 | notes                                                                                               |
| ------------------------------------------------ | ------------------------------------------------- | ----------------------------------- | -------------------------------------------------------------------------------------------- | --------------------------------------- | ----------------------- | ----------------------------------- | ------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------- |
| packages/data/src/createClient.ts                | mobile                                            | anon                                | n/a (client init)                                                                            | n/a                                     | low                     | Shared Supabase client factory      | n/a                                                                                        | Used by mobile `SessionProvider` to create a browser/mobile Supabase client.                        |
| apps/mobile/src/providers/SessionProvider.tsx    | mobile                                            | anon                                | patients, results_wide, prescriptions (via shared hooks)                                     | select                                  | med                     | Mobile session bootstrapping        | n/a                                                                                        | Creates mobile Supabase client with public anon key; enables direct PHI access in shared hooks.     |
| packages/data/src/hooks/usePatientProfile.ts     | mobile                                            | anon                                | patients                                                                                     | select                                  | high                    | Mobile Home (profile/greeting)      | apps/web/app/api/mobile/patient/login/route.ts                                             | Could reuse login payload/session instead of querying `patients` directly.                          |
| packages/data/src/hooks/useLabResults.ts         | mobile                                            | anon                                | results_wide                                                                                 | select                                  | high                    | Mobile lab results (hook)           | apps/web/app/api/mobile/patient-results/route.ts                                           | Not currently imported in `apps/mobile`; still exposes direct PHI access if used.                   |
| packages/data/src/hooks/usePrescriptions.ts      | mobile                                            | anon                                | prescriptions, prescription_items                                                            | select                                  | high                    | Mobile prescriptions list (hook)    | apps/web/app/api/mobile/patient/prescriptions/route.ts                                     | Not currently imported in `apps/mobile`; still exposes direct PHI access if used.                   |
| apps/web/lib/supabaseBrowser.ts                  | web client                                        | anon                                | n/a (client init)                                                                            | n/a                                     | low                     | Web browser client helper           | n/a                                                                                        | No direct usage found in `apps/web`.                                                                |
| apps/web/lib/supabase.ts                         | web client                                        | anon                                | n/a (client init)                                                                            | n/a                                     | low                     | Web browser client helper           | n/a                                                                                        | `getSupabaseBrowser()` defined but not used in `apps/web`.                                          |
| apps/web/app/(patient)/patient/page.tsx          | web server                                        | service (fallback anon)             | prescriptions, patients, medical_certificates, results_flat/results_wide (via data provider) | select                                  | med                     | Patient portal home                 | apps/web/app/api/patient/prescriptions/route.ts; apps/web/app/api/patient-results/route.ts | Server component; uses service-role key (fallback anon). Provider visit lookup hits results tables. |
| apps/web/app/(patient)/patient/medcerts/page.tsx | web server                                        | service (fallback anon)             | medical_certificates                                                                         | select                                  | med                     | Patient portal medical certificates | n/a                                                                                        | No patient-facing med-cert API route found.                                                         |
| apps/web/app/(patient)/patient/delivery/page.tsx | web server                                        | service (fallback anon)             | patients                                                                                     | select                                  | med                     | Patient portal delivery address     | apps/web/app/api/mobile/patient/delivery-address/route.ts                                  | Server component; uses service-role key (fallback anon).                                            |
| apps/web/components/FollowUpCard.tsx             | web server                                        | service                             | followups                                                                                    | select                                  | med                     | Patient portal follow-up card       | apps/web/app/api/mobile/patient/followups/route.ts                                         | Server component using `supabaseAdmin()` (service role).                                            |

## Service-Role Exposure Checks

- No `NEXT_PUBLIC_*` or `EXPO_PUBLIC_*` service-role envs found in code.
- `SUPABASE_SERVICE_ROLE_KEY` usage appears confined to server-only modules and server components.
- Notable server-side fallback: several patient portal pages select `SUPABASE_SERVICE_ROLE_KEY || SUPABASE_SERVICE_ROLE || NEXT_PUBLIC_SUPABASE_ANON_KEY` (server components, not client).

## Top 5 Highest-Risk Items

1. packages/data/src/hooks/usePatientProfile.ts (mobile): direct `patients` table access from client.
2. packages/data/src/hooks/useLabResults.ts (mobile): direct `results_wide` access from client (PHI).
3. packages/data/src/hooks/usePrescriptions.ts (mobile): direct `prescriptions` + `prescription_items` access from client (PHI).
4. apps/mobile/src/providers/SessionProvider.tsx (mobile): creates anon Supabase client enabling direct PHI queries.
5. apps/web/app/(patient)/patient/page.tsx (web server): service-role Supabase queries inside a page module with PHI tables.
